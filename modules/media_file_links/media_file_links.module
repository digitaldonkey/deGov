<?php

/**
 * @file
 * The deGov Media file links module.
 */

/**
 * Implements hook_locale_translation_projects_alter().
 */
function media_file_links_locale_translation_projects_alter(&$projects) {
  $projects['media_file_links'] = [
    'info' => [
      'name'                                 => 'Media file links',
      'interface translation project'        => 'media_file_links',
      'interface translation server pattern' => drupal_get_path('module', 'media_file_links') . '/translations/%language.po',
    ],
  ];
}

function media_file_links_entity_base_field_info_alter(&$fields, \Drupal\Core\Entity\EntityTypeInterface $entity_type) {
  if ($entity_type->id() === 'menu_link_content' && isset($fields['link'])) {
    $fields['link'] = \Drupal\Core\Field\BaseFieldDefinition::create('media_file_link')
      ->setLabel(t('Link'))
      ->setDescription(t('The location this menu link points to.'))
      ->setRequired(TRUE)
      ->setSettings([
        'link_type' => \Drupal\link\LinkItemInterface::LINK_GENERIC,
        'title' => DRUPAL_DISABLED,
      ])
      ->setDisplayOptions('form', [
        'type' => 'link_default',
        'weight' => -2,
      ])
      ->setProvider('menu_link_content')
      ->setName('link')
      ->setTargetEntityTypeId('menu_link_content')
      ->setTargetBundle(null);
  }
}

function media_file_links_form_menu_link_content_menu_link_content_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if (!empty($form['link']['widget'][0]['uri']['#element_validate']) && is_array($form['link']['widget'][0]['uri']['#element_validate'])) {
    foreach ($form['link']['widget'][0]['uri']['#element_validate'] as $key => $validator) {
      if (is_array($validator) && in_array('validateUriElement', $validator)) {
        unset($form['link']['widget'][0]['uri']['#element_validate'][$key]);
      }
    }
    $form['link']['widget'][0]['uri']['#element_validate'][] = [
      'Drupal\media_file_links\Plugin\Field\FieldWidget\MediaFileLinkWidget',
      'validateUriElement',
    ];
  }
}